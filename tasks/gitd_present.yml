---

- name: present | Git package is present
  apt:
    name: git
    state: present
    update_cache: yes
    cache_valid_time: 3600

- name: present | Git user is present
  user:
    name: git
    shell: /usr/bin/git-shell
    system: no

- name: present | Git bare repositories are absent
  with_items: relkit_gitd_repositories
  when: item.state == "absent"
  command: "rm -rf /home/git/{{ item.name }}.git"


- name: present | Git bare repositories are present
  with_items: relkit_gitd_repositories
  when: item.state == "present"
  file:
    group: git
    name: "/home/git/{{ item.name }}.git"
    owner: git
    state: directory

- name: present | Git bare repositories are initialized
  with_items: relkit_gitd_repositories
  when: item.state == "present"
  shell: "git init --bare chdir=/home/git/{{ item.name }}.git"
  sudo: git

- name: present | Git service
  debug:
    msg: |
      Gitd does not come with a service manifest, use a 3rd-party role to generate one.
      To start the service manually, run:
      $ sudo -u git /usr/bin/git daemon --enable=upload-archive --export-all --syslog --user=git --group=git --reuseaddr --base-path=/home/git/ /home/git/
