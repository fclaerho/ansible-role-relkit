---

# REFS:
# http://www.aptly.info/doc/overview/
# http://www.unixmen.com/introducing-aptly-a-debian-repository-management-tool/

- name: present | Aptly debian repository key is present
  apt_key:
    keyserver: keys.gnupg.net
    id: E083A3782A194991
    state: present

- name: present | Aptly debian repository is present
  apt_repository:
    repo: "deb http://repo.aptly.info/ squeeze main"
    state: present

- name: present | Aptly package is present
  apt:
    name: aptly
    state: present
    update_cache: yes
    cache_valid_time: 3600

- name: present | Aptly user is present
  user:
    name: aptly
    state: present
    system: yes

- name: present | Aptly is configured
  copy:
    src: aptly.conf
    dest: /etc
    mode: "644"
    owner: root

- name: present | Aptly cache location is present
  file:
    path: /var/cache/aptly
    mode: "700"
    owner: aptly
    group: aptly
    state: directory

- name: present | Aptly repositories are assessed
  sudo: yes
  sudo_user: aptly
  command: aptly repo list
  register: cmd
  changed_when: no

- name: present | Aptly repositories are traced
  debug:
    var: cmd.stdout_lines

- name: present | Testing repository is present
  with_items: aptly_repositories
  when: "'[{{ item.name }}]' not in cmd.stdout"
  sudo: yes
  sudo_user: aptly
  command: "aptly repo create {{ item.name }}"


- name: present | Aptly published repositories are assessed
  command: aptly publish list
  register: cmd
  changed_when: no

- name: present | Aptly published repositories are traced
  debug:
    var: cmd.stdout_lines

- name: present | Testing repository is published
  with_items: relkit_aptly_repositories
  when: "'./{{ item.distribution }}' not in cmd.stdout"
  sudo: yes
  sudo_user: aptly
  command: "aptly publish repo -distribution={{ item.distribution }} -architectures=all,source,x86,amd64 -skip-signing=true {{ item.name }}"

- name: present | Aptly services
  debug:
    msg: |
      Aptly does not come with any service manifest, use a 3rd-party role to generate them.
      To start the services manually, run:
      $ sudo -u aptly /usr/bin/aptly serve -listen={{ syskit_aptly_dl_address }}:{{ syskit_aptly_dl_port }}
      $ sudo -u aptly /usr/bin/aptly api serve -listen={{ syskit_aptly_api_address }}:{{ syskit_aptly_api_port }}
